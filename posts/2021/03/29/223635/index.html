<!doctype html><html lang=ja><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>mimemagicに依存しなくなったmarcelのmime type判定の変化には気をつけようって話 | QWYNG.dev</title>
<meta property="og:title" content="mimemagicに依存しなくなったmarcelのmime type判定の変化には気をつけようって話 | QWYNG.dev"><meta name=twitter:title content="mimemagicに依存しなくなったmarcelのmime type判定の変化には気をつけようって話 | QWYNG.dev"><meta itemprop=name content="mimemagicに依存しなくなったmarcelのmime type判定の変化には気をつけようって話 | QWYNG.dev"><meta name=application-name content="mimemagicに依存しなくなったmarcelのmime type判定の変化には気をつけようって話 | QWYNG.dev"><meta property="og:site_name" content><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><meta property="og:locale" content="ja"><meta name=language content="ja"><link rel=alternate hreflang=en href=https://qwyng.dev/posts/2021/03/29/223635/ title><meta property="og:type" content="article"><meta property="og:article:published_time" content=2021-03-29T22:36:00+0900><meta property="article:published_time" content=2021-03-29T22:36:00+0900><meta property="og:url" content="https://qwyng.dev/posts/2021/03/29/223635/"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"mimemagicに依存しなくなったmarcelのmime type判定の変化には気をつけようって話","author":{"@type":"Person","name":""},"datePublished":"2021-03-29","description":"","wordCount":1118,"mainEntityOfPage":"True","dateModified":"2021-03-29","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"QWYNG.dev"}}</script><meta name=generator content="Hugo 0.134.0"><meta property="og:description" content="
mimemagic gemのライセンス問題で色々ありましたね。ライセンスは法的な問題なので確認も難しい問題でした。
さて、marcelからmimemagicへの依存が無くなってmime typeの判定がApache Tikaを元にしたものになりました。"><meta property="og:type" content="website"><meta property="og:title" content="mimemagicに依存しなくなったmarcelのmime type判定の変化には気をつけようって話 - QWYNG.dev"><meta property="og:url" content="https://qwyng.dev/posts/2021/03/29/223635/"><meta name=og:image content="https://qwyng.dev/"><meta name=twitter:card content="summary"><link rel=canonical href=https://qwyng.dev/posts/2021/03/29/223635/><link href=/style.min.e390ba7da26222f4dc42a349955d76dbbe44e5ce2535a43de5a70633a0a9ec3c.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://qwyng.dev/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg><script async src="https://www.googletagmanager.com/gtag/js?id=G-9JVVYL7X5D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9JVVYL7X5D")}</script></head><body data-theme class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://qwyng.dev/ class=logo><svg width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title/><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
</a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/about/>About</a></li><li><a class=menu-link href=/posts/>記事一覧</a></li><li><a class=menu-link href=/index.xml>RSS</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>mimemagicに依存しなくなったmarcelのmime type判定の変化には気をつけようって話</h1><div class=post-meta><time datetime=2021-03-29T22:36:00+09:00 itemprop=datePublished>Mar 29, 2021</time></div></header><div class=page-content><body><p>mimemagic gemのライセンス問題で色々ありましたね。ライセンスは法的な問題なので確認も難しい問題でした。</p><p>さて、marcelからmimemagicへの依存が無くなって<a class=keyword href=http://d.hatena.ne.jp/keyword/mime>mime</a> typeの判定が<a href=https://tika.apache.org/>Apache Tika</a>を元にしたものになりました。</p><p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fhackmd.io%2F%40mametter%2Fmimemagic-info-ja" title="mimemagicの最新動向 - HackMD" class="embed-card embed-webcard" scrolling=no frameborder=0 style="display:block;width:100%;height:155px;max-width:500px;margin:10px 0"></iframe><cite class=hatena-citation><a href=https://hackmd.io/@mametter/mimemagic-info-ja>hackmd.io</a></cite></p><p>しかし、この変更にはmarcelの<a class=keyword href=http://d.hatena.ne.jp/keyword/mime>mime</a> type判定結果が変化するものが含まれていました。<br>例えば、以下のsample.xlsxというファイルの<a class=keyword href=http://d.hatena.ne.jp/keyword/mime>mime</a> typeの判定をMarcel: 1.0.0、0,3,3それぞれに行わせると...</p><pre class=code data-lang data-unlink> ❯ xxd sample.xlsx                                                                                          
00000000: 504b 0304 1400 0808 0800 3123 7d52 0000  PK........1#}R..
00000010: 0000 0000 0000 0000 0000 1800 0000 786c  ..............xl
00000020: 2f64 7261 7769 6e67 732f 6472 6177 696e  /drawings/drawin
00000030: 6731 2e78 6d6c 9dd0 5d6e c230 0c07 f013  g1.xml..]n.0....
00000040: ec0e 55de 695a 1813 4314 5ed0 4e30 0ee0  ..U.iZ..C.^.N0..
00000050: 256e 1b91 8fca 0ea3 dc7e d14a 3669 7b01  %n.......~.J6i{.
00000060: 1e6d cb3f f9ef cd6e 74b6 f844 6213 7c23  .m.?...nt..Db.|#

❯ file -i sample.xlsx                                                                                
sample.xlsx: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet; charset=binary </pre><pre class="code lang-ruby" data-lang=ruby data-unlink> irb(main):001:0&gt; require 'marcel'
=&gt; true
irb(main):002:0&gt; Marcel::VERSION
=&gt; "1.0.0"
irb(main):003:0&gt; require 'pathname'
=&gt; true
irb(main):004:0&gt; Marcel::MimeType.for Pathname.new('sample.xlsx')
=&gt; "application/zip"
 </pre><pre class="code lang-ruby" data-lang=ruby data-unlink> irb(main):001:0&gt; require 'marcel'
=&gt; true
irb(main):002:0&gt; Marcel::VERSION
=&gt; "0.3.3"
irb(main):003:0&gt; require 'pathname'
=&gt; true
irb(main):004:0&gt; Marcel::MimeType.for Pathname.new('sample.xlsx')
=&gt; "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
 </pre><p>このように同じファイルに対して判定結果が異なっています。</p><p>この理由はmarcelのmimemagicをreplaceした差分でわかります。</p><p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Frails%2Fmarcel%2Fcommit%2F2e58d1986715420f0abbba060b6e158d6f4d3a05%23diff-9b02d25e1e56ac702cc60a32120253b3de0635f6ee9893631eea95ef5744b77aL2" title="Replace mimemagic with Apache Tika's mime types data · rails/marcel@2e58d19" class="embed-card embed-webcard" scrolling=no frameborder=0 style="display:block;width:100%;height:155px;max-width:500px;margin:10px 0"></iframe><cite class=hatena-citation><a href=https://github.com/rails/marcel/commit/2e58d1986715420f0abbba060b6e158d6f4d3a05#diff-9b02d25e1e56ac702cc60a32120253b3de0635f6ee9893631eea95ef5744b77aL2>github.com</a></cite></p><p>marcelは<code>lib/marcel/mime_type/definitions.rb</code>内にて <code>'require 'mimemagic/overlay'</code>していました。
<code>mimemagic/overlay</code>はxlsxやらpptやらをapplication/zipと区別してくれる<code>MimeMagic.add</code>をしていたファイルです。<br>最初に貼ったmimemagic最新動向の記事でも触れられていましたね。</p><p>この<code>'require 'mimemagic/overlay'</code>が無くなったことによってmarcelはxlsxやらpptをapplication/zipと判定するようになりました。<a href=#f-96753e88 name=fn-96753e88 title="一部のxlsxとかpptはmarcel 1.0.0でもそのままapplication/zipと区別してくれるかもしれません。マジックナンバーにあまり詳しくないのでわかりませんが、特定のマジックナンバーを持つxlsxとかpptも存在するかも">*1</a></p><p>marcelのREADMEにはもともと</p><blockquote><p>By preference, the magic number data in any passed in file is used to determine the type. If this doesn't work, it uses the type gleaned from the filename, extension, and finally the declared type. If no valid type is found in any of these, "application/octet-stream" is returned.</p><p>Some types aren't easily recognised solely by magic number data. For example <a class=keyword href=http://d.hatena.ne.jp/keyword/Adobe%20Illustrator>Adobe Illustrator</a> files have the same magic number as PDFs (and can usually even be viewed in PDF viewers!). For these types, Marcel uses both the magic number data and the file name to work out the type:</p></blockquote><p>とあるので、書いてある通りファイル名を渡すのがとりあえずの対処策になるかと思います。</p><pre class="code lang-ruby" data-lang=ruby data-unlink> irb(main):001:0&gt; require 'marcel'
=&gt; true
irb(main):002:0&gt; Marcel::VERSION
=&gt; "1.0.0"
irb(main):003:0&gt; require 'pathname'
=&gt; true
irb(main):004:0&gt; Marcel::MimeType.for Pathname.new('sample.xlsx')
=&gt; "application/zip"
irb(main):005:0&gt; Marcel::MimeType.for Pathname.new('sample.xlsx'), name: 'sample.xlsx'
=&gt; "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
 </pre><p><code>shrine</code>には<a href=https://github.com/shrinerb/shrine/blob/master/doc/plugins/determine_mime_type.md>そういったオプション</a>もありますね。</p><p>xlsxとかpptを扱う<a class=keyword href=http://d.hatena.ne.jp/keyword/Rails>Rails</a>アプリはそれなりに存在するでしょうから各位気をつけていきましょう。</p><p>追記</p><p>@furish さんがPR投げてくれてますね　ある場でこの人と話した内容がこの記事の発端でもあります。
<iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Frails%2Fmarcel%2Fissues%2F35" title="compatibility is broken with certain types of office documents · Issue #35 · rails/marcel" class="embed-card embed-webcard" scrolling=no frameborder=0 style="display:block;width:100%;height:155px;max-width:500px;margin:10px 0"></iframe><cite class=hatena-citation><a href=https://github.com/rails/marcel/issues/35>github.com</a></cite></p><div class=footnote><p class=footnote><a href=#fn-96753e88 name=f-96753e88 class=footnote-number>*1</a><span class=footnote-delimiter>:</span><span class=footnote-text>一部のxlsxとかpptはmarcel 1.0.0でもそのままapplication/zipと区別してくれるかもしれません。<a class=keyword href=http://d.hatena.ne.jp/keyword/%A5%DE%A5%B8%A5%C3%A5%AF%A5%CA%A5%F3%A5%D0%A1%BC>マジックナンバー</a>にあまり詳しくないのでわかりませんが、特定の<a class=keyword href=http://d.hatena.ne.jp/keyword/%A5%DE%A5%B8%A5%C3%A5%AF%A5%CA%A5%F3%A5%D0%A1%BC>マジックナンバー</a>を持つxlsxとかpptも存在するかも</span></p></div></body></div></article></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/QWYNG target=_blank rel="noopener noreferrer me" title=Github><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://twitter.com/qwyngg target=_blank rel="noopener noreferrer me" title=Twitter><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg>
</a><a href=/index.xml target=_blank rel="noopener noreferrer me" title=Rss><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>© 2024 .</small></footer><script src=https://qwyng.dev/js/main.min.4ee188e1744c19816e95a540b2650ed9f033ea0371e74eac8e717355cfca8741.js integrity="sha256-TuGI4XRMGYFulaVAsmUO2fAz6gNx506sjnFzVc/Kh0E="></script></body></html>